name: Auto-merge when green

on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize, labeled, ready_for_review]

jobs:
  automerge:
    if: github.event.pull_request.base.ref == 'main'
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
    runs-on: ubuntu-latest
    steps:
      - name: Check label and merge if green
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function hasLabel(name) {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: pr.number });
              return labels.some(l => l.name.toLowerCase() === name.toLowerCase());
            }

            if (!(await hasLabel('automerge'))) {
              core.info('No automerge label; skipping');
              return;
            }

            if (pr.draft) {
              core.info('PR is draft; skipping');
              return;
            }

            // Get combined status for the head SHA
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: pr.head.sha });
            core.info(`Combined status: ${status.state}`);
            if (status.state !== 'success') {
              core.info('Checks not successful yet; skipping');
              return;
            }

            // Try to merge with squash to satisfy linear history
            try {
              await github.rest.pulls.merge({ owner, repo, pull_number: pr.number, merge_method: 'squash', commit_title: pr.title });
              core.info('PR merged successfully.');
            } catch (e) {
              core.warning(`Merge failed: ${e.message}`);
            }
