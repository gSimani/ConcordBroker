name: Validate UI Fields

on:
  # Run on pushes to main
  push:
    branches: [main, master]

  # Run on pull requests
  pull_request:
    branches: [main, master]

  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      url:
        description: 'Website URL to validate'
        required: false
        default: ''
      property_ids:
        description: 'Comma-separated property IDs (optional)'
        required: false
        default: ''

jobs:
  validate-ui-fields:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('apps/validation/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd apps/validation
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install chromium

      - name: Run UI Field Validation
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
        run: |
          # Use manual input URL if provided, otherwise use default staging URL
          URL="${{ github.event.inputs.url }}"
          if [ -z "$URL" ]; then
            URL="${{ secrets.STAGING_URL }}"
          fi

          PROPERTY_IDS="${{ github.event.inputs.property_ids }}"

          if [ -z "$PROPERTY_IDS" ]; then
            # Validate entire site
            python -m apps.validation.ui_field_validator \
              --url "$URL" \
              --format all \
              --output-dir ./validation_reports
          else
            # Validate specific properties
            python -m apps.validation.ui_field_validator \
              --property-ids "$PROPERTY_IDS" \
              --format all \
              --output-dir ./validation_reports
          fi

      - name: Upload validation reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: validation-reports-${{ github.run_number }}
          path: ./validation_reports/
          retention-days: 30

      - name: Check for critical mismatches
        id: check_mismatches
        run: |
          # Parse JSON report to check for mismatches
          REPORT=$(ls ./validation_reports/*.json | head -1)
          MISMATCHES=$(python -c "
          import json
          with open('$REPORT') as f:
              data = json.load(f)
              total_mismatches = sum(
                  r.get('summary', {}).get('mismatched', 0)
                  for r in data
              )
              print(total_mismatches)
          ")

          echo "mismatches=$MISMATCHES" >> $GITHUB_OUTPUT

          if [ "$MISMATCHES" -gt 0 ]; then
            echo "âš ï¸ Found $MISMATCHES data mismatches!"
            exit 1
          else
            echo "âœ… All fields validated successfully!"
            exit 0
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // Find markdown report
            const reports = fs.readdirSync('./validation_reports')
              .filter(f => f.endsWith('.md'));

            if (reports.length === 0) {
              console.log('No markdown report found');
              return;
            }

            const reportContent = fs.readFileSync(
              `./validation_reports/${reports[0]}`,
              'utf8'
            );

            // Extract summary from report
            const summaryMatch = reportContent.match(/## Summary\n\n([\s\S]*?)\n\n##/);
            const summary = summaryMatch ? summaryMatch[1] : 'See report for details';

            const comment = `## ðŸ” UI Field Validation Results

            ${summary}

            ðŸ“„ **Full reports available in workflow artifacts**

            ${parseInt('${{ steps.check_mismatches.outputs.mismatches }}') > 0
              ? 'âš ï¸ **Action required:** Data mismatches found. Review the report for details.'
              : 'âœ… **All fields validated successfully!**'
            }
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Send Sentry alert on failure
        if: failure() && steps.check_mismatches.outputs.mismatches > 0
        run: |
          # Send alert to Sentry
          curl -X POST https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/issues/ \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "UI Field Validation Failed",
              "culprit": "UI Field Validator",
              "level": "warning",
              "message": "Found ${{ steps.check_mismatches.outputs.mismatches }} data mismatches in UI validation"
            }' || echo "Failed to send Sentry alert"

      - name: Notify via webhook (optional)
        if: failure()
        run: |
          # Send notification to your webhook endpoint
          if [ ! -z "${{ secrets.VALIDATION_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.VALIDATION_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "event": "ui_validation_failed",
                "mismatches": ${{ steps.check_mismatches.outputs.mismatches }},
                "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }'
          fi
