<!DOCTYPE html>
<html>
<head>
    <title>Simple MiniPropertyCard Test</title>
    <style>
        .property-card {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .value-section {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .label {
            color: #666;
            font-size: 12px;
        }
        .value {
            font-weight: bold;
            color: #d4af37;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Simple MiniPropertyCard Test</h1>
    <div id="results"></div>

    <script>
        // Simulate exact data structure from PropertyService
        const sampleData = {
            parcel_id: '064210010010',
            phy_addr1: '123 Main Street',
            phy_city: 'Fort Lauderdale',
            phy_zipcd: '33301',
            own_name: 'John Smith',
            jv: 450000,
            lnd_val: 180000,
            tot_lvg_area: 2200,
            lnd_sqfoot: 8500,
            act_yr_blt: 2005,
            dor_uc: '001',
            county: 'BROWARD'
        };

        // Simulate the exact helper functions from MiniPropertyCard
        const getAppraisedValue = (data) => {
            const value = data.jv || data.just_value || data.appraised_value || data.market_value || data.assessed_value;
            console.log('getAppraisedValue checking fields:', {
                jv: data.jv,
                just_value: data.just_value,
                appraised_value: data.appraised_value,
                market_value: data.market_value,
                assessed_value: data.assessed_value,
                final_value: value
            });
            return value;
        };

        const formatCurrency = (value) => {
            console.log('formatCurrency called with value:', value, 'type:', typeof value);
            console.log('formatCurrency value is falsy:', !value);
            console.log('formatCurrency value === undefined:', value === undefined);
            console.log('formatCurrency value === null:', value === null);

            if (!value && value !== 0) return 'N/A';
            if (value >= 1000000000) {
                return `$${(value / 1000000000).toFixed(1)}B`;
            }
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            }
            if (value >= 1000) {
                return `$${(value / 1000).toFixed(0)}K`;
            }
            return `$${value}`;
        };

        // Test the exact flow
        console.log('=== Starting Test ===');
        console.log('Sample data:', sampleData);
        console.log('Sample data jv field:', sampleData.jv);

        // Simulate what happens in MiniPropertyCard
        console.log('MiniPropertyCard data received:', sampleData);
        console.log('Specific jv value:', sampleData.jv);

        // Create enhanced data (like in MiniPropertyCard with useSalesData)
        const enhancedData = {
            ...sampleData,
            sale_prc1: sampleData.sale_prc1 || undefined,
            sale_yr1: sampleData.sale_yr1 || undefined,
            sale_date: sampleData.sale_date || undefined
        };

        console.log('Enhanced data with sales:', enhancedData);

        // Test getAppraisedValue
        const appraisedValue = getAppraisedValue(sampleData);
        console.log('Appraised value result:', appraisedValue);

        // Test formatCurrency
        const formattedValue = formatCurrency(appraisedValue);
        console.log('Formatted value result:', formattedValue);

        // Display results
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
            <div class="property-card">
                <h3>${sampleData.phy_addr1}</h3>
                <p><strong>Owner:</strong> ${sampleData.own_name}</p>

                <div class="value-section">
                    <span class="label">Original jv field:</span>
                    <span class="value">${sampleData.jv}</span>
                </div>

                <div class="value-section">
                    <span class="label">getAppraisedValue result:</span>
                    <span class="value">${appraisedValue}</span>
                </div>

                <div class="value-section">
                    <span class="label">formatCurrency result:</span>
                    <span class="${formattedValue === 'N/A' ? 'error' : 'success'}">${formattedValue}</span>
                </div>

                <div class="value-section">
                    <span class="label">Expected:</span>
                    <span class="success">$450K</span>
                </div>

                <div class="value-section">
                    <span class="label">Test Result:</span>
                    <span class="${formattedValue === '$450K' ? 'success' : 'error'}">
                        ${formattedValue === '$450K' ? 'PASS ✓' : 'FAIL ✗'}
                    </span>
                </div>
            </div>
        `;

        // Test with undefined jv field to simulate the problem
        const brokenData = {
            ...sampleData,
            jv: undefined
        };

        console.log('=== Testing with undefined jv ===');
        const brokenAppraisedValue = getAppraisedValue(brokenData);
        const brokenFormattedValue = formatCurrency(brokenAppraisedValue);
        console.log('Broken data result:', brokenFormattedValue);

        resultsDiv.innerHTML += `
            <div class="property-card">
                <h3>Test with undefined jv field</h3>
                <div class="value-section">
                    <span class="label">jv field:</span>
                    <span class="error">${brokenData.jv}</span>
                </div>
                <div class="value-section">
                    <span class="label">Result:</span>
                    <span class="error">${brokenFormattedValue}</span>
                </div>
                <p><em>This simulates what happens when jv is undefined</em></p>
            </div>
        `;

        console.log('=== Test Complete ===');
    </script>
</body>
</html>