<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Supabase Autocomplete - Lightning Fast</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            margin-left: 10px;
            display: inline-block;
        }
        .status-badge.live {
            background: #10b981;
            color: white;
        }
        .status-badge.connecting {
            background: #f59e0b;
            color: white;
        }
        .status-badge.error {
            background: #ef4444;
            color: white;
        }
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .suggestions-dropdown.active {
            display: block;
        }
        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .suggestion-item:hover {
            background-color: #f7f7f7;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-icon {
            font-size: 20px;
        }
        .suggestion-text {
            flex: 1;
        }
        .suggestion-primary {
            color: #1f2937;
            font-weight: 500;
        }
        .suggestion-secondary {
            color: #6b7280;
            font-size: 14px;
            margin-top: 2px;
        }
        .property-type {
            color: #3b82f6;
            font-weight: 500;
        }
        .owner-name {
            color: #059669;
            font-weight: 500;
        }
        .loading-indicator {
            padding: 12px 20px;
            color: #6b7280;
            text-align: center;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            flex: 1;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }
        .selected-value {
            margin-top: 20px;
            padding: 15px;
            background: #eff6ff;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            display: none;
        }
        .selected-value.active {
            display: block;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #86efac;
        }
        .alert.warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fb923c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Live Supabase Property Autocomplete
            <span class="status-badge connecting" id="statusBadge">Connecting...</span>
        </h1>

        <div class="alert info">
            <strong>Live Data Mode:</strong> Connected to Supabase with 7+ million Florida properties.
            Smart caching ensures responses under 100ms for common queries.
        </div>

        <div class="search-container">
            <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="Try '3930', 'MIAMI', 'DAVIE', or any address..."
                autocomplete="off"
            >
            <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
        </div>

        <div class="selected-value" id="selectedValue">
            <strong>Selected:</strong> <span id="selectedText"></span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="suggestionCount">0</div>
                <div class="stat-label">Suggestions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="responseTime">0ms</div>
                <div class="stat-label">Response Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dataSource">Live</div>
                <div class="stat-label">Data Source</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:8003';  // Main API
        const FALLBACK_API_URL = 'http://localhost:8001';  // Fallback API (if available)

        // Cache for instant repeat queries
        const queryCache = new Map();
        const CACHE_TTL = 30000; // 30 seconds

        // Elements
        const searchInput = document.getElementById('searchInput');
        const dropdown = document.getElementById('suggestionsDropdown');
        const selectedValue = document.getElementById('selectedValue');
        const selectedText = document.getElementById('selectedText');
        const statusBadge = document.getElementById('statusBadge');

        // Check API status on load
        checkAPIStatus();

        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_URL}/`, {
                    signal: AbortSignal.timeout(2000)
                });

                if (response.ok) {
                    const data = await response.json();
                    statusBadge.textContent = 'Live';
                    statusBadge.className = 'status-badge live';
                    console.log('Lightning API connected:', data);

                    // Warm up cache with common queries
                    warmupCache();
                } else {
                    statusBadge.textContent = 'Fallback Mode';
                    statusBadge.className = 'status-badge warning';
                }
            } catch (error) {
                console.error('API check failed:', error);
                statusBadge.textContent = 'Error';
                statusBadge.className = 'status-badge error';
            }
        }

        async function warmupCache() {
            // Preload common prefixes in background
            const commonQueries = ['3930', '1000', '500', 'MIAMI', 'FORT', 'DAVIE'];

            for (const query of commonQueries) {
                fetch(`${API_URL}/api/autocomplete/addresses?q=${encodeURIComponent(query)}&limit=10`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.data) {
                            setCacheEntry(query, data.data);
                        }
                    })
                    .catch(err => console.log('Warmup query failed:', query));
            }
        }

        function setCacheEntry(query, data) {
            queryCache.set(query.toUpperCase(), {
                data: data,
                timestamp: Date.now()
            });
        }

        function getCacheEntry(query) {
            const entry = queryCache.get(query.toUpperCase());
            if (entry && (Date.now() - entry.timestamp) < CACHE_TTL) {
                return entry.data;
            }
            queryCache.delete(query.toUpperCase());
            return null;
        }

        async function fetchSuggestions(query) {
            const startTime = performance.now();

            // Check cache first
            const cached = getCacheEntry(query);
            if (cached) {
                const endTime = performance.now();
                return {
                    suggestions: cached,
                    time: (endTime - startTime).toFixed(2),
                    source: 'Cache'
                };
            }

            // Try multiple query variations for better results
            const queryVariations = [
                query,  // Original
                query.replace(/\s+/g, ' '),  // Normalize spaces
                query.replace(/sw/gi, 'SW'),  // Fix common abbreviations
                query.replace(/nw/gi, 'NW'),
                query.replace(/se/gi, 'SE'),
                query.replace(/ne/gi, 'NE')
            ];

            for (const variation of queryVariations) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);

                    const response = await fetch(
                        `${API_URL}/api/autocomplete/addresses?q=${encodeURIComponent(variation)}&limit=20`,
                        {
                            signal: controller.signal,
                            headers: {
                                'Accept': 'application/json',
                            }
                        }
                    );

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const data = await response.json();

                        if (data.success && data.data && data.data.length > 0) {
                            const endTime = performance.now();

                            // Cache the successful result
                            setCacheEntry(query, data.data);

                            // Update stats
                            document.getElementById('dataSource').textContent = data.cached ? 'Cached' : 'Live';

                            return {
                                suggestions: data.data,
                                time: data.response_time_ms || (endTime - startTime).toFixed(2),
                                source: 'API'
                            };
                        }
                    }
                } catch (error) {
                    console.log(`Query variation "${variation}" failed:`, error.message);
                }
            }

            // If all variations fail, try broader search
            const broadQuery = query.split(' ')[0];  // Just first term
            if (broadQuery.length >= 3) {
                try {
                    const response = await fetch(
                        `${API_URL}/api/autocomplete/addresses?q=${encodeURIComponent(broadQuery)}&limit=30`,
                        { signal: AbortSignal.timeout(2000) }
                    );

                    if (response.ok) {
                        const data = await response.json();

                        if (data.success && data.data) {
                            // Filter results client-side for relevance
                            const filtered = data.data.filter(item => {
                                const searchText = `${item.address} ${item.city} ${item.owner_name}`.toUpperCase();
                                return query.split(' ').every(term => searchText.includes(term.toUpperCase()));
                            }).slice(0, 15);

                            if (filtered.length > 0) {
                                const endTime = performance.now();
                                return {
                                    suggestions: filtered,
                                    time: (endTime - startTime).toFixed(2),
                                    source: 'Filtered'
                                };
                            }
                        }
                    }
                } catch (error) {
                    console.log('Broad search failed:', error);
                }
            }

            // Return empty if nothing found
            const endTime = performance.now();
            return {
                suggestions: [],
                time: (endTime - startTime).toFixed(2),
                source: 'None'
            };
        }

        function displaySuggestions(results) {
            const { suggestions, time } = results;

            // Update stats
            document.getElementById('suggestionCount').textContent = suggestions.length;
            document.getElementById('responseTime').textContent = `${time}ms`;

            if (suggestions.length === 0) {
                dropdown.innerHTML = '<div class="loading-indicator">No suggestions found. Try broader terms.</div>';
                dropdown.classList.add('active');
                return;
            }

            dropdown.innerHTML = '';
            suggestions.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';

                // Choose icon based on property type
                let icon = 'üè†';
                const propType = item.property_type || 'Residential';
                if (propType.includes('Commercial')) icon = 'üè¢';
                else if (propType.includes('Industrial')) icon = 'üè≠';
                else if (propType.includes('Government')) icon = 'üèõÔ∏è';
                else if (propType.includes('Vacant')) icon = 'üèûÔ∏è';

                // Format display
                const address = item.address || item.phy_addr1 || '';
                const city = item.city || item.phy_city || '';
                const zipCode = item.zip_code || item.phy_zipcd || '';
                const owner = item.owner_name || '';

                div.innerHTML = `
                    <div class="suggestion-icon">${icon}</div>
                    <div class="suggestion-text">
                        <div class="suggestion-primary">${address}</div>
                        <div class="suggestion-secondary">
                            <span class="property-type">${propType}</span> ‚Ä¢
                            ${city} ${zipCode}
                            ${owner ? ` ‚Ä¢ <span class="owner-name">${owner}</span>` : ''}
                        </div>
                    </div>
                `;

                div.addEventListener('click', () => selectSuggestion(item));
                dropdown.appendChild(div);
            });

            dropdown.classList.add('active');
        }

        function selectSuggestion(item) {
            const address = item.address || item.phy_addr1 || '';
            const city = item.city || item.phy_city || '';
            const zipCode = item.zip_code || item.phy_zipcd || '';
            const owner = item.owner_name || 'Unknown';

            searchInput.value = address;
            selectedText.textContent = `${address}, ${city} ${zipCode} (Owner: ${owner})`;
            selectedValue.classList.add('active');
            dropdown.classList.remove('active');

            console.log('Selected property:', item);
        }

        // Handle search input
        let debounceTimer = null;
        let currentRequest = null;

        searchInput.addEventListener('input', async (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value.trim();

            if (query.length < 2) {
                dropdown.classList.remove('active');
                return;
            }

            // Show loading immediately
            dropdown.innerHTML = '<div class="loading-indicator"><span class="spinner"></span> Searching...</div>';
            dropdown.classList.add('active');

            // Cancel any pending request
            if (currentRequest) {
                currentRequest.abort();
            }

            // Debounce the actual search
            debounceTimer = setTimeout(async () => {
                currentRequest = new AbortController();

                try {
                    const results = await fetchSuggestions(query);
                    displaySuggestions(results);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Search error:', error);
                        dropdown.innerHTML = '<div class="loading-indicator">Error loading suggestions</div>';
                    }
                }
            }, 200);  // 200ms debounce
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                dropdown.classList.remove('active');
            }
        });

        // Handle keyboard navigation
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                dropdown.classList.remove('active');
            }
        });

        // Focus on load
        searchInput.focus();
    </script>
</body>
</html>