<!DOCTYPE html>
<html>
<head>
    <title>MiniPropertyCard Database Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: green; }
        .error { color: red; }
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .property-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        .property-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .type-residential { background: #e6f4ea; color: #137333; }
        .type-commercial { background: #e8f0fe; color: #1967d2; }
        .type-government { background: #fce8e6; color: #c5221f; }
        .type-vacant { background: #f1f3f4; color: #5f6368; }
        .property-address {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        .property-city {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 12px;
        }
        .property-owner {
            font-size: 14px;
            color: #34495e;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        .property-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .metric {
            display: flex;
            flex-direction: column;
        }
        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #95a5a6;
            margin-bottom: 2px;
        }
        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        .parcel-id {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ecf0f1;
            font-size: 12px;
            color: #95a5a6;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 8px 12px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #3498db;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç MiniPropertyCard Database Connection Test</h1>

        <div class="status" id="status">
            <h3>Connection Status</h3>
            <div id="api-status">‚è≥ Checking API connection...</div>
            <div id="supabase-status">‚è≥ Checking Supabase connection...</div>
            <div id="data-status">‚è≥ Waiting for data...</div>
        </div>

        <div class="controls">
            <input type="text" id="cityInput" placeholder="Enter city (e.g., Miami)" value="Miami">
            <button onclick="searchProperties()">Search Properties</button>
            <button onclick="testDirectSupabase()">Test Direct Supabase</button>
        </div>

        <div id="properties-container">
            <div class="loading">Enter a city and click Search to load properties...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const SUPABASE_URL = 'https://pmispwtdngkcmsrsjwbp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtaXNwd3RkbmdrY21zcnNqd2JwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NTY5NTgsImV4cCI6MjA3MjUzMjk1OH0.YvWR1NkVByTY10Vzpzt4jMtMjBszD_BOCsQDBfG951A';

        // Check API connection on load
        async function checkConnections() {
            // Check API
            try {
                const apiResponse = await fetch(`${API_URL}/health`);
                const apiData = await apiResponse.json();
                document.getElementById('api-status').innerHTML =
                    `<span class="success">‚úÖ API Connected (Port 8000) - ${apiData.service || 'Property API'}</span>`;
            } catch (error) {
                document.getElementById('api-status').innerHTML =
                    `<span class="error">‚ùå API Connection Failed: ${error.message}</span>`;
            }

            // Check Supabase
            try {
                const supabaseResponse = await fetch(`${SUPABASE_URL}/rest/v1/florida_parcels?select=count&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (supabaseResponse.ok) {
                    document.getElementById('supabase-status').innerHTML =
                        `<span class="success">‚úÖ Supabase Connected (pmispwtdngkcmsrsjwbp)</span>`;
                } else {
                    document.getElementById('supabase-status').innerHTML =
                        `<span class="error">‚ùå Supabase Error: ${supabaseResponse.status}</span>`;
                }
            } catch (error) {
                document.getElementById('supabase-status').innerHTML =
                    `<span class="error">‚ùå Supabase Connection Failed: ${error.message}</span>`;
            }
        }

        // Get property category from code (matching MiniPropertyCard logic)
        function getPropertyCategoryFromCode(propertyUse, propertyUseDesc) {
            const code = String(propertyUse || '').trim();

            if (code === '0' || code === '00') return 'Vacant Land';
            if (code === '1' || code === '01') return 'Residential';
            if (code === '2' || code === '02') return 'Residential';
            if (code === '3' || code === '03') return 'Residential';
            if (code === '4' || code === '04') return 'Commercial';
            if (code === '5' || code === '05') return 'Commercial';
            if (code === '6' || code === '06') return 'Commercial';
            if (code === '7' || code === '07') return 'Commercial';
            if (code === '8' || code === '08') return 'Industrial';
            if (code === '9' || code === '09') return 'Industrial';
            if (code === '10') return 'Agricultural';
            if (code === '11') return 'Agricultural';
            if (code === '12') return 'Agricultural';

            if (code.startsWith('9')) return 'Government';

            return 'Unknown';
        }

        // Format currency
        function formatCurrency(value) {
            if (!value && value !== 0) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        // Create property card HTML
        function createPropertyCard(property) {
            const category = getPropertyCategoryFromCode(property.propertyUse || property.property_use);
            const categoryClass = category.toLowerCase().replace(/\s+/g, '-');

            return `
                <div class="property-card">
                    <div class="property-header">
                        <span class="property-type type-${categoryClass}">${category}</span>
                        ${property.propertyUse ? `<span style="font-size: 11px; color: #95a5a6;">Code: ${property.propertyUse}</span>` : ''}
                    </div>
                    <div class="property-address">
                        ${property.phy_addr1 || property.address || 'No Street Address'}
                    </div>
                    <div class="property-city">
                        ${property.phy_city || property.city}, FL ${property.phy_zipcd || property.zipCode || ''}
                    </div>
                    <div class="property-owner">
                        <strong>Owner:</strong> ${property.owner_name || property.own_name || property.owner || 'N/A'}
                    </div>
                    <div class="property-metrics">
                        <div class="metric">
                            <span class="metric-label">Appraised Value</span>
                            <span class="metric-value">${formatCurrency(property.jv || property.justValue)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Taxable Value</span>
                            <span class="metric-value">${formatCurrency(property.tv_sd || property.taxableValue)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Land Sq Ft</span>
                            <span class="metric-value">${property.lnd_sqfoot || property.landSqFt || 'N/A'}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Year Built</span>
                            <span class="metric-value">${property.act_yr_blt || property.yearBuilt || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="parcel-id">
                        Parcel ID: ${property.parcel_id || property.id}
                    </div>
                </div>
            `;
        }

        // Search properties via API
        async function searchProperties() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                alert('Please enter a city name');
                return;
            }

            const container = document.getElementById('properties-container');
            container.innerHTML = '<div class="loading">üîÑ Loading properties...</div>';

            try {
                const response = await fetch(`${API_URL}/api/properties/search?city=${encodeURIComponent(city)}&limit=12`);
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    document.getElementById('data-status').innerHTML =
                        `<span class="success">‚úÖ Loaded ${data.data.length} properties from database</span>`;

                    const propertyCards = data.data.map(property => createPropertyCard(property)).join('');
                    container.innerHTML = `<div class="property-grid">${propertyCards}</div>`;

                    console.log('Properties loaded:', data.data);
                } else {
                    container.innerHTML = '<div class="loading">No properties found for this city.</div>';
                    document.getElementById('data-status').innerHTML =
                        `<span class="error">‚ö†Ô∏è No properties found</span>`;
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                container.innerHTML = `<div class="error">Error loading properties: ${error.message}</div>`;
                document.getElementById('data-status').innerHTML =
                    `<span class="error">‚ùå Error loading data: ${error.message}</span>`;
            }
        }

        // Test direct Supabase connection
        async function testDirectSupabase() {
            const container = document.getElementById('properties-container');
            container.innerHTML = '<div class="loading">üîÑ Testing direct Supabase connection...</div>';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/florida_parcels?select=*&limit=6&phy_city=eq.Miami`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                const data = await response.json();

                if (data && data.length > 0) {
                    document.getElementById('data-status').innerHTML =
                        `<span class="success">‚úÖ Direct Supabase: Loaded ${data.length} properties</span>`;

                    const propertyCards = data.map(property => createPropertyCard(property)).join('');
                    container.innerHTML = `<div class="property-grid">${propertyCards}</div>`;

                    console.log('Direct Supabase properties:', data);
                } else {
                    container.innerHTML = '<div class="loading">No properties found in direct query.</div>';
                }
            } catch (error) {
                console.error('Direct Supabase error:', error);
                container.innerHTML = `<div class="error">Direct Supabase error: ${error.message}</div>`;
            }
        }

        // Initialize on load
        window.onload = function() {
            checkConnections();
        };
    </script>
</body>
</html>